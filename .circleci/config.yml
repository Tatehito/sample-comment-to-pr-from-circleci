version: 2.1

jobs:
  build-preview:
    working_directory: ~/repo
    docker:
      - image: cimg/ruby:2.7.6-node
    steps:
      - checkout
      - restore_cache:
          name: Restore Cache
          keys:
            - v1-dependencies-{{ checksum "yarn.lock" }}
            - v1-dependencies
      - run:
          name: Install Dependencies
          command: |
            yarn install --frozen-lockfile --cache-folder ~/.cache/yarn
      - save_cache:
          name: Save Cache
          key: v1-dependencies-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn
            - ./vendor/bundle
      # - run:
      #     name: Setup Server
      #     command: |
      #       bundle exec rake contentful && bundle exec jekyll build
      # - run:
      #     name: Deploy Preview
      #     command: |
      #       yarn netlify deploy --build --context deploy-preview \
      #       --dir ./_site \
      #       --auth ${NETLIFY_AUTH_TOKEN} --site ${NETLIFY_SITE_ID}
      - run:
          name: Deploy Preview
          command: |
            result="
────────────────────────────────────────────────────────────────
  Netlify Build                                                 
────────────────────────────────────────────────────────────────
​
❯ Version
  @netlify/build 27.20.6
​
❯ Flags
  {}
​
❯ Current directory
  /home/circleci/repo
​
❯ Config file
  No config file was defined: using default values.
​
❯ Context
  deploy-preview
​
────────────────────────────────────────────────────────────────
  Netlify Build Complete                                        
────────────────────────────────────────────────────────────────
​
(Netlify Build completed in 12ms)
Deploy path: /home/circleci/repo/_site
Deploying to draft URL...

Logs:              https://app.netlify.com/sites/scintillating-piroshki-928a9d/deploys/64060dda7a20d50b6715d62f
Website Draft URL: https://64060dda7a20d50b6715d62f--scintillating-piroshki-928a9d.netlify.app

If everything looks good on your draft URL, deploy it to your main site URL with the --prod flag.
netlify deploy --build --prod" &&
            echo "${result}" &&
            body=`echo "${result}" | grep 'Website Draft URL'` &&
            curl -X POST \
              -H "Content-Type:application/json" \
              -H "Authorization: token ${GITHUB_TOKEN}" \
              -d "{\"body\": \"${body}\"}" \
              "https://api.github.com/repos/Tatehito/sample-comment-to-pr-from-circleci/issues/${CIRCLE_PULL_REQUEST##*/}/comments"

workflows:
  build:
    jobs:
      - build-preview:
          filters:
            branches:
              ignore:
                - main
